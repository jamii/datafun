%% Notes to myself:
%%
%% Sans-serifs to consider: noto, plex-sans[semibold], lato
%% Lato unfortunately lacks small caps.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{rntzfont}[2018/07/02]
\RequirePackage{etoolbox}       % for \ifdefstring
\RequirePackage{xfp}            % multiplying scaling factors with \fpeval
\RequirePackage{xkeyval}        % key-value options

%% ---------- 1. Package options ----------
\DeclareOptionX{scaled}[1.0]{\edef\rntz@fontscale{#1}}

%% serif font options
\DeclareOptionX{baskerville}{\def\rntz@font{baskerville}}
\DeclareOptionX{charter}{\def\rntz@font{charter}}
\DeclareOptionX{cochineal}{\def\rntz@font{cochineal}}
\DeclareOptionX{fbb}{\def\rntz@font{fbb}}
\DeclareOptionX{libertine}{\def\rntz@font{libertine}}
\DeclareOptionX{palatino}{\def\rntz@font{palatino}}
\DeclareOptionX{pt}{\def\rntz@font{pt}}

%% math font options
\DeclareOptionX{newmath}{\def\rntz@mathfont{newmath}}
\DeclareOptionX{euler}{\def\rntz@mathfont{euler}}

\ExecuteOptionsX{scaled,charter,euler} % default options
\ProcessOptionsX\relax                 % is \relax necessary here?


%% ---------- 2. Miscellany ----------
%% Utilities for scaling used inside this file.
\newcommand{\@scaled}[1]{\fpeval{#1*\rntz@fontscale}}
\edef\rntz@eulerscale{1}

%% TO CONSIDER:
%\PassOptionsToPackage{euler-digits}{eulervm}
%\usepackage[full]{textcomp} % what does this do?

%% inconsolata[varqu] - Uses straight double & single quotes.
%% Other options I haven't used:
%% - varl makes l not vertical, ugh.
%% - var0 removes the slash in 0, which is less clear for code.
\PassOptionsToPackage{varqu}{inconsolata}

%% newtxmath[vvarbb] - A more readable variant blackboard bold.
%% Other useful options to newtxmath:
%% baskerv{aldx,ille}, libertine, cochineal, utopia.
\PassOptionsToPackage{vvarbb}{newtxmath}
\PassOptionsToPackage{vvarbb}{newpxmath}


%% ---------- 3. Text font choices ----------
% Baskervaldx is too heavy, baskervillef is way too light. I like
% librebaskerville, but it doesn't have small caps :(.
\ifdefstring{\rntz@font}{baskerville}{
  %\RequirePackage[p,osf,scaled=1.0526]{Baskervaldx}
  \RequirePackage[scaled=\@scaled{0.86315}]{librebaskerville}
  \RequirePackage[p,osf,scaled=\@scaled{1.0526}]{biolinum}
  \RequirePackage[scaled=\@scaled{.995}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{euler}{\@eulervm{1}}{
    \RequirePackage[libertine,scaled=\@scaled{1.0526}]{newtxmath}
    %\RequirePackage[baskerville,scaled=1.0711]{newtxmath}
    %\RequirePackage[baskervaldx,scaled=1.0526]{newtxmath}
  }
  \linespread{\@scaled{1.06}}
}{}

\ifdefstring{\rntz@font}{charter}{
  %% XCharter can be scaled. It has an option [osf] for old-style proportional
  %% figures, but lacks proportional lining figures, and so doesn't respect
  %% fontaxes' \tbfigures or \lnfigures.
  \RequirePackage[sups,scaled=\@scaled{0.967}]{XCharter}
  \RequirePackage[proportional,semibold,scaled=\@scaled{.955}]{sourcesanspro}
  \RequirePackage[scaled=\@scaled{1.019}]{inconsolata}

  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[xcharter,scaled=\@scaled{1.05}]{newtxmath}
  }{}
  \linespread{\@scaled{1.05}} % 1.02-1.05?
}{}

\ifdefstring{\rntz@font}{cochineal}{
  \RequirePackage[p,osf,sups,scale=\@scaled{1.08}]{cochineal}
  \RequirePackage[p,osf,scaled=\@scaled{1.065}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.015}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath} {
    \RequirePackage[cochineal,scaled=\@scaled{1.08}]{newtxmath}
  }{}
  \linespread{\@scaled{1.1}}   % 1.02-1.05? 1.08? 1.12-1.15?? agh, I don't know.
}{}

\ifdefstring{\rntz@font}{fbb}{
  \RequirePackage[p,osf,scaled=\@scaled{1}]{fbb}
  \RequirePackage[p,osf,scaled=\@scaled{1.02}]{biolinum}
  \RequirePackage[scaled=\@scaled{0.965}]{inconsolata}
  \edef\rntz@eulerscale{0.95}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[cochineal,scaled=\@scaled{1.03}]{newtxmath}
  }{}
  \linespread{\@scaled{1.1}}
}{}

\ifdefstring{\rntz@font}{libertine}{
  % libertine[osf] makes newtxmath use old-style figures in math mode :(
  % Other options: semibold.
  \RequirePackage[p,mono=false,llscale=\@scaled{1.0526},scale=\@scaled{1.0526}]
                 {libertine}
  \RequirePackage[scaled=\@scaled{.995}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[libertine,scaled=\@scaled{1.0526}]{newtxmath}
  }{}
  \linespread{\@scaled{1.07}}
}{}

\ifdefstring{\rntz@font}{palatino}{
  \RequirePackage[scaled=\@scaled{1}]{newpxtext}
  \RequirePackage[scaled=\@scaled{1.067}]{biolinum}
  \RequirePackage[scaled=\@scaled{1.012}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[scaled=\@scaled{1}]{newpxmath}
  }{}
  \linespread{\@scaled{1.08333}}

  %% HACK: newpxtext doesn't respect fontaxes' \tbfigures! :( but it _does_
  %% define, eg., \tlfstyle! hm...
  \RequirePackage{fontaxes}
  \renewcommand\tbfigures{}
  \renewcommand\lnfigures{}
}{}

\ifdefstring{\rntz@font}{pt}{
  \RequirePackage[scaled=\@scaled{0.93}]{PTSerif}
  \RequirePackage[scaled=\@scaled{0.93}]{PTSans}
  %% PTSans doesn't have small caps; could use biolinum or sourcesanspro instead.
  %\RequirePackage[scaled=1.135]{biolinum}
  \RequirePackage[scaled=\@scaled{1.04}]{inconsolata}
  \ifdefstring{\rntz@mathfont}{newmath}{
    \RequirePackage[utopia,scaled=\@scaled{1.05726}]{newtxmath}
  }{}
  \linespread{\@scaled{1.126}}
}{}


%% ---------- 4. Final tweaks & cleanup ----------
%% Load euler as math alphabet if requested
\ifdefstring{\rntz@mathfont}{euler}{
  \RequirePackage{eulervm}
  \edef\zeu@Scale{\@scaled{\rntz@eulerscale}} % scale eulervm font.
}

%% Adjust calendar alphabet.
%% TODO: check scaling of \mathcal in example.tex!
%% Other options: cal={cm,pxtx,boondoxo}.
\RequirePackage[cal=pxtx]{mathalfa}

%% Make sure \mathbold is defined.
\ifdefined\mathbold\else\newcommand\mathbold{\boldsymbol}\fi

%% undefine \@scaled
\let\@scaled\relax
